AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'nested

  Sample SAM Template for nested

  '
Resources:
  StockTradingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: ../../statemachine/stock_trader.asl.json
      DefinitionSubstitutions:
        StockCheckerFunctionArn:
          Fn::GetAtt:
          - Child
          - Outputs.StockCheckerFunctionArn
        StockSellerFunctionArn:
          Fn::GetAtt:
          - Child
          - Outputs.StockSellerFunctionArn
        StockBuyerFunctionArn:
          Fn::GetAtt:
          - StockBuyerFunction
          - Arn
        DDBPutItem:
          Fn::Sub: arn:${AWS::Partition}:states:::dynamodb:putItem
        DDBTable:
          Fn::GetAtt:
          - Child
          - Outputs.TransactionTableName
      Events:
        HourlyTradingSchedule:
          Type: Schedule
          Properties:
            Description: Schedule to run the stock trading state machine every hour
            Enabled: false
            Schedule: rate(1 hour)
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Fn::GetAtt:
            - Child
            - Outputs.StockCheckerFunctionName
      - LambdaInvokePolicy:
          FunctionName:
            Fn::GetAtt:
            - Child
            - Outputs.StockSellerFunctionName
      - LambdaInvokePolicy:
          FunctionName:
            Ref: StockBuyerFunction
      - DynamoDBWritePolicy:
          TableName:
            Fn::GetAtt:
            - Child
            - Outputs.TransactionTableName
  StockBuyerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StockBuyerFunction
      Handler: app.lambdaHandler
      Runtime: nodejs12.x
  Child:
    Type: AWS::Serverless::Application
    Properties:
      Location: ../../child.yaml
Outputs:
  StockTradingStateMachineArn:
    Description: Stock Trading state machine ARN
    Value:
      Ref: StockTradingStateMachine
  StockTradingStateMachineRole:
    Description: IAM Role created for Stock Trading state machine based on the specified
      SAM Policy Templates
    Value:
      Fn::GetAtt:
      - StockTradingStateMachineRole
      - Arn
